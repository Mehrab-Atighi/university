"Health_Complications",
"Goverment_Complications",
"CentralInsurance_Pension_Pr",
"ValueAdded_Tax",
"ValueAdded_Complications",
"Insurer_Pension_Pr",
"Net_Pr",
"ID_PolicyLuncher_Departmant",
"ID_PolicyLuncher_Province",
"ID_LunchDate",
"ID_PolicyHolderName",
"ID_MarkettingBy",
"ID_AutomobileType",
"ID_AutomobileGroup",
"ID_AutomobileClass",
"ID_AutomobuileUssage",
"ID_StartDate",
"ID_EndDate",
"ID_RegisterUser",
"ID_Policy",
"ID_PolicyHolderType",
"ID_LastInsurer",
"ID_AutomobileZipCode",
"ID_AutomobileSystem",
"ID_AutomobileZipCodeType",
"ID_Passengers_Claim",
"ID_Finance_Claim",
"ID_Life_Claim"
)
save(df_with_coding , file = "df_with_coding.RData")
View(coded_dfs)
View(coded_dfs[["شماره کامل"]])
library(dplyr)
library(readxl)
library(ggplot2)
library(DBI)
library(tidyverse)
library(data.table)
file.list = list.files( pattern='*.xlsx' , recursive = TRUE )
Claims <- lapply(file.list[1:3], read_excel)
# bind each files with row
all_claims_df = bind_rows(Claims,.id = "t")
all_claims_df$t = ifelse(all_claims_df$t == 1 , "LifeClaim" , ifelse(all_claims_df$t == 1 , "PassengerClaim"  ,"FinanceClaim" ))
df_claims  = as.data.table(
all_claims_df[,c(4,17,47:55)]
)
save(df_claims , file = "Claims_list.RData")
load("df_with_coding.RData")
load("Claims_list.RData")
load("coded_dfs.RData")
View(coded_dfs)
names(coded_dfs[["شماره کامل"]])
View(df_claims)
View(coded_dfs)
View(coded_dfs[["شماره کامل"]])
df_claims
View(df_claims)
View(df_claims)
df_claims
#  file.list = list.files( pattern='*.xlsx' , recursive = TRUE )
Claims <- lapply(file.list[1:3], read_excel)
# bind each files with row
all_claims_df = bind_rows(Claims,.id = "t")
all_claims_df$t = ifelse(all_claims_df$t == 1 , "LifeClaim" , ifelse(all_claims_df$t == 1 , "PassengerClaim"  ,"FinanceClaim" ))
df_claims  = as.data.table(
all_claims_df[,c(4,17,47:55)]
)
names(df_claims)
all_claims_df[,c(4,17,47:55)]
all_claims_df
# bind each files with row
all_claims_df = bind_rows(Claims,.id = "t")
file.list = list.files( pattern='*.xlsx' , recursive = TRUE )
#  file.list = list.files( pattern='*.xlsx' , recursive = TRUE )
Claims <- lapply(file.list[1:3], read_excel)
# bind each files with row
all_claims_df = bind_rows(Claims,.id = "t")
all_claims_df$t = ifelse(all_claims_df$t == 1 , "LifeClaim" , ifelse(all_claims_df$t == 1 , "PassengerClaim"  ,"FinanceClaim" ))
df_claims  = as.data.table(
all_claims_df[,c(4,17,47:55)]
)
names(df_claims)
all_claims_df[,c(4,17,47:55)]
all_claims_df
View(all_claims_df)
df_claims  = as.data.table(
all_claims_df[,c(5,18,47:55)]
)
names(df_claims)[2] = c("ID_Policy")
names(df_claims)
save(df_claims , file = "Claims_list.RData")
library(dplyr)
library(readxl)
library(ggplot2)
library(DBI)
library(tidyverse)
library(data.table)
load("df_with_coding.RData")
load("Claims_list.RData")
load("coded_dfs.RData")
names(coded_dfs[["شماره کامل"]])[2] = "ID_Policy"
claims_with_code = left_join(df_claims , coded_dfs[["شماره کامل"]] , by = "ID_Policy" )
coded_dfs[["شماره کامل"]]$ID_Policy = as.character(coded_dfs[["شماره کامل"]]$ID_Policy)
claims_with_code = left_join(df_claims , coded_dfs[["شماره کامل"]] , by = "ID_Policy" )
claims_with_code
View(claims_with_code)
load("df_with_coding.RData")
load("Claims_list.RData")
load("coded_dfs.RData")
names(coded_dfs[["شماره کامل"]])[1] = "ID_Policy"
coded_dfs[["شماره کامل"]]$ID_Policy = as.character(coded_dfs[["شماره کامل"]]$ID_Policy)
claims_with_code = left_join(df_claims , coded_dfs[["شماره کامل"]] , by = "ID_Policy" )
View(claims_with_code)
View(claims_with_code)
claims_with_code = left_join(df_claims , coded_dfs[["شماره کامل"]] , by = "ID_Policy",keep = F )
claims_with_code
View(claims_with_code)
claims_with_code = claims_with_code[,-2] #remove ID_Ploicy column
names(claims_with_code)
names(claims_with_code)[10]
names(claims_with_code)[11]
names(claims_with_code)[11] = "ID_Policy"
FinalDf = left_join(df_with_coding , claims_with_code , by = "ID_Policy")
View(FinalDf)
library(ggplot2)
library(DBI)
library(tidyverse)
library(data.table)
#  file.list = list.files( pattern='*.xlsx' , recursive = TRUE )
Claims <- lapply(file.list[1:3], read_excel)
# bind each files with row
all_claims_df = bind_rows(Claims,.id = "t")
all_claims_df$t = ifelse(all_claims_df$t == 1 , "LifeClaim" , ifelse(all_claims_df$t == 1 , "PassengerClaim"  ,"FinanceClaim" ))
df_claims  = as.data.table(
all_claims_df[,c(5,18,48:55)]
)
names(df_claims)[2] = c("ID_Policy")
save(df_claims , file = "Claims_list.RData")
library(dplyr)
library(readxl)
library(ggplot2)
library(DBI)
library(tidyverse)
library(data.table)
load("df_with_coding.RData")
load("Claims_list.RData")
load("coded_dfs.RData")
names(coded_dfs[["شماره کامل"]])[1] = "ID_Policy"
coded_dfs[["شماره کامل"]]$ID_Policy = as.character(coded_dfs[["شماره کامل"]]$ID_Policy)
claims_with_code = left_join(df_claims , coded_dfs[["شماره کامل"]] , by = "ID_Policy",keep = F )
claims_with_code = claims_with_code[,-2] #remove ID_Ploicy column
View(claims_with_code)
coded_dfs[["شماره کامل"]]
claims_with_code = left_join(df_claims , coded_dfs[["شماره کامل"]] , by = "ID_Policy",keep = F )
claims_with_code = claims_with_code[,-c(2:3)] #remove ID_Ploicy column
names(claims_with_code)[11]
names(claims_with_code)[10]
names(claims_with_code)[10] = "ID_Policy"
FinalDf = left_join(df_with_coding , claims_with_code , by = "ID_Policy")
file.list = list.files( pattern='*.xlsx' , recursive = TRUE )
Claims <- lapply(file.list[1:3], read_excel)
View(claims_with_code)
View(claims)
View(Claims)
View(Claims[[1]])
file.list[1:3]
Claims[[1]]$`کل  مبلغ حواله پرداختنی`
names(Claims[[1]])
names(Claims[[1]])[54]
file.list[1:3]
names(Claims[[1]])[54] = "LifeLoss_Value"
names(Claims[[2]])[54] = "PassengerLoss_Value"
names(Claims[[3]])[54] = "FinanceLoss_Value"
# bind each files with row
all_claims_df = bind_rows(Claims)
View(all_claims_df)
library(dplyr)
library(readxl)
library(ggplot2)
library(DBI)
library(tidyverse)
library(data.table)
#read all policies excel files with .xlsx pattern.
file.list = list.files( pattern='*.xlsx' , recursive = TRUE )
Claims <- lapply(file.list[1:3], read_excel)
names(Claims[[1]])[54] = "LifeLoss_Value"
names(Claims[[2]])[54] = "PassengerLoss_Value"
names(Claims[[3]])[54] = "FinanceLoss_Value"
# bind each files with row
all_claims_df = bind_rows(Claims)
#remove some columns manualy
df_claims  = as.data.table(
all_claims_df[,c(18,54,56,57)]
)
names(df_claims)[2] = c("ID_Policy")
save(df_claims , file = "Claims_list.RData")
load("df_with_coding.RData")
load("Claims_list.RData")
load("coded_dfs.RData")
names(coded_dfs[["شماره کامل"]])[1] = "ID_Policy"
coded_dfs[["شماره کامل"]]$ID_Policy = as.character(coded_dfs[["شماره کامل"]]$ID_Policy)
claims_with_code = left_join(df_claims , coded_dfs[["شماره کامل"]] , by = "ID_Policy",keep = F )
coded_dfs[["شماره کامل"]]$ID_Policy = as.character(coded_dfs[["شماره کامل"]]$ID_Policy)
claims_with_code = left_join(df_claims , coded_dfs[["شماره کامل"]] , by = "ID_Policy",keep = F )
load("df_with_coding.RData")
load("Claims_list.RData")
load("coded_dfs.RData")
names(coded_dfs[["شماره کامل"]])[1] = "ID_Policy"
# coded_dfs[["شماره کامل"]]$ID_Policy = as.character(coded_dfs[["شماره کامل"]]$ID_Policy)
claims_with_code = left_join(df_claims , coded_dfs[["شماره کامل"]] , by = "ID_Policy",keep = F )
df_claims
df_claims
df_claims
library(dplyr)
library(readxl)
library(ggplot2)
library(DBI)
library(tidyverse)
library(data.table)
file.list = list.files( pattern='*.xlsx' , recursive = TRUE )
Claims <- lapply(file.list[1:3], read_excel)
names(Claims[[1]])[54] = "LifeLoss_Value"
names(Claims[[2]])[54] = "PassengerLoss_Value"
names(Claims[[3]])[54] = "FinanceLoss_Value"
# bind each files with row
all_claims_df = bind_rows(Claims)
View(all_claims_df)
df_claims  = as.data.table(
all_claims_df[,c(17,54,56,57)]
)
names(df_claims)
names(df_claims)[1] = c("ID_Policy")
save(df_claims , file = "Claims_list.RData")
load("df_with_coding.RData")
load("Claims_list.RData")
load("coded_dfs.RData")
names(coded_dfs[["شماره کامل"]])[1] = "ID_Policy"
# coded_dfs[["شماره کامل"]]$ID_Policy = as.character(coded_dfs[["شماره کامل"]]$ID_Policy)
claims_with_code = left_join(df_claims , coded_dfs[["شماره کامل"]] , by = "ID_Policy",keep = F )
claims_with_code
claims_with_code = claims_with_code[,-c(1)] #remove ID_Ploicy column
claims_with_code
names(claims_with_code)[4] = "ID_Policy"
FinalDf = left_join(df_with_coding , claims_with_code , by = "ID_Policy")
View(FinalDf)
for(i in 2:4){
df_claims[,i] = ifelse(is.na(df_claims[,i]) , 0  , df_claims[,i])
}
i
df_claims[,i]
file.list = list.files( pattern='*.xlsx' , recursive = TRUE )
Claims <- lapply(file.list[1:3], read_excel)
names(Claims[[1]])[54] = "LifeLoss_Value"
names(Claims[[2]])[54] = "PassengerLoss_Value"
names(Claims[[3]])[54] = "FinanceLoss_Value"
# bind each files with row
all_claims_df = bind_rows(Claims)
df_claims  = as.data.table(
all_claims_df[,c(17,54,56,57)]
)
names(df_claims)[1] = c("ID_Policy")
for(i in 2:4){
df_claims[,i] = ifelse(is.na(df_claims[,i]) , 0  , df_claims[,i])
}
df_claims[,i]
df_claims
df_claims[,i]
df_claims = as.data.frame(df_claims)
names(df_claims)[1] = c("ID_Policy")
for(i in 2:4){
df_claims[,i] = ifelse(is.na(df_claims[,i]) , 0  , df_claims[,i])
}
df_claims
save(df_claims , file = "Claims_list.RData")
library(dplyr)
library(readxl)
library(ggplot2)
library(DBI)
library(tidyverse)
library(data.table)
load("df_with_coding.RData")
load("Claims_list.RData")
load("coded_dfs.RData")
names(coded_dfs[["شماره کامل"]])[1] = "ID_Policy"
# coded_dfs[["شماره کامل"]]$ID_Policy = as.character(coded_dfs[["شماره کامل"]]$ID_Policy)
claims_with_code = left_join(df_claims , coded_dfs[["شماره کامل"]] , by = "ID_Policy",keep = F )
claims_with_code = claims_with_code[,-c(1)] #remove ID_Ploicy column
names(claims_with_code)[4] = "ID_Policy"
FinalDf = left_join(df_with_coding , claims_with_code , by = "ID_Policy")
View(FinalDf)
gc()
library(dplyr)
library(readxl)
library(ggplot2)
library(DBI)
library(tidyverse)
library(data.table)
file.list = list.files( pattern='*.xlsx' , recursive = TRUE )
policies <- lapply(file.list[4:33], read_excel)
#
# # bind each files with row
all_policies_df = bind_rows(policies)
df_sodor  = as.data.table(
all_policies_df[,-c(1,2,3,4,10,19,20,23,26,28,29,33,34,35,36,37)]
)
df_sodor =
df_sodor %>%
separate(col = `سابقه مالی / جانی`, into = c("c1", "FinanceHistory","LifeHistory"), sep = ":", remove = T)
df_sodor = df_sodor[,-c(which(names(df_sodor) == "c1"))]
df_sodor$FinanceHistory = substr(df_sodor$FinanceHistory ,
start = 1, stop = nchar(df_sodor$FinanceHistory)-6)
df_sodor= as.data.table(df_sodor)
save(df_sodor , file = "policies_list.RData")
# ایجاد یک داده‌فریم نمونه با 40 ستون categorical
set.seed(123)
coded_dfs <- list()
categorical_columns <- names(which(
sapply(df_sodor, is.factor) | sapply(df_sodor, is.character) == T))
# حلقه برای کددهی به هر ستون و ایجاد داده‌فریم جداگانه
for (col in categorical_columns) {
# ایجاد ستون کد
df_sodor[, paste0(col, "_Code") := as.numeric(factor(get(col)))]
# ایجاد داده‌فریم جداگانه برای این ستون
coded_dfs[[col]] <- df_sodor[, .(get(col), get(paste0(col, "_Code")))]
coded_dfs[[col]] <- unique(df_sodor[, .(get(col), get(paste0(col, "_Code")))])
names(coded_dfs[[col]]) <- c(col, paste0(col, "_Code"))
}
save(coded_dfs , file = "coded_dfs.RData")
df_sodor = as.data.frame(df_sodor)
df_with_coding = df_sodor[,which(names(df_sodor) %notin% categorical_columns)]
# remove some linearity columns mannulay for example A+B-C = D
df_with_coding = df_with_coding[,-c(21,22)]
names(df_with_coding)
names(df_with_coding) = c("PolicyHolderCode" ,
"Duration",
"CarProductYear",
"SideCover_MR",
"FinanceCover_MR",
"AccidentCover_MR",
"ThirdParty_Pr",
"MultipleBloodMoney_Pr",
"ExcessLife_Pr",
"ExcessFinance_Pr",
"DriverAccident_Pr",
"Pension_Pr",
"Basis_Pr",
"Health_Complications",
"Goverment_Complications",
"CentralInsurance_Pension_Pr",
"ValueAdded_Tax",
"ValueAdded_Complications",
"Insurer_Pension_Pr",
"Net_Pr",
"ID_PolicyLuncher_Departmant",
"ID_PolicyLuncher_Province",
"ID_LunchDate",
"ID_PolicyHolderName",
"ID_MarkettingBy",
"ID_AutomobileType",
"ID_AutomobileGroup",
"ID_AutomobileClass",
"ID_AutomobuileUssage",
"ID_StartDate",
"ID_EndDate",
"ID_RegisterUser",
"ID_Policy",
"ID_PolicyHolderType",
"ID_LastInsurer",
"ID_AutomobileZipCode",
"ID_AutomobileSystem",
"ID_AutomobileZipCodeType",
"ID_Passengers_Claim",
"ID_Finance_Claim",
"ID_Life_Claim"
)
save(df_with_coding , file = "df_with_coding.RData")
gc()
library(dplyr)
library(readxl)
library(ggplot2)
library(DBI)
library(tidyverse)
library(data.table)
load("df_with_coding.RData")
load("Claims_list.RData")
load("coded_dfs.RData")
names(coded_dfs[["شماره کامل"]])[1] = "ID_Policy"
# coded_dfs[["شماره کامل"]]$ID_Policy = as.character(coded_dfs[["شماره کامل"]]$ID_Policy)
claims_with_code = left_join(df_claims , coded_dfs[["شماره کامل"]] , by = "ID_Policy",keep = F )
claims_with_code = claims_with_code[,-c(1)] #remove ID_Ploicy column
names(claims_with_code)[4] = "ID_Policy"
FinalDf = left_join(df_with_coding , claims_with_code , by = "ID_Policy")
View(FinalDf)
library(dplyr)
library(readxl)
library(ggplot2)
library(DBI)
library(tidyverse)
library(data.table)
file.list = list.files( pattern='*.xlsx' , recursive = TRUE )
Claims <- lapply(file.list[1:3], read_excel)
names(Claims[[1]])[54] = "LifeLoss_Value"
names(Claims[[2]])[54] = "PassengerLoss_Value"
names(Claims[[3]])[54] = "FinanceLoss_Value"
# bind each files with row
all_claims_df = bind_rows(Claims)
df_claims  = as.data.table(
all_claims_df[,c(17,54,56,57)]
)
df_claims = as.data.frame(df_claims)
names(df_claims)[1] = c("ID_Policy")
for(i in 2:4){
df_claims[,i] = ifelse(is.na(df_claims[,i]) , 0  , df_claims[,i])
}
df_claims
save(df_claims , file = "Claims_list.RData")
load("Claims_list.RData")
load("coded_dfs.RData")
names(coded_dfs[["شماره کامل"]])[1] = "ID_Policy"
# coded_dfs[["شماره کامل"]]$ID_Policy = as.character(coded_dfs[["شماره کامل"]]$ID_Policy)
claims_with_code = left_join(df_claims , coded_dfs[["شماره کامل"]] , by = "ID_Policy",keep = F )
claims_with_code = claims_with_code[,-c(1)] #remove ID_Ploicy column
names(claims_with_code)[4] = "ID_Policy"
FinalDf = left_join(df_with_coding , claims_with_code , by = "ID_Policy")
View(FinalDf)
View(FinalDf)
for(i in 42:44){
FinalDf[,i] = ifelse(is.na(FinalDf[,i]) , 0  , FinalDf[,i])
}
library(dplyr)
library(readxl)
library(ggplot2)
library(DBI)
library(tidyverse)
library(data.table)
load("df_with_coding.RData")
load("Claims_list.RData")
load("coded_dfs.RData")
names(coded_dfs[["شماره کامل"]])[1] = "ID_Policy"
# coded_dfs[["شماره کامل"]]$ID_Policy = as.character(coded_dfs[["شماره کامل"]]$ID_Policy)
claims_with_code = left_join(df_claims , coded_dfs[["شماره کامل"]] , by = "ID_Policy",keep = F )
claims_with_code = claims_with_code[,-c(1)] #remove ID_Ploicy column
names(claims_with_code)[4] = "ID_Policy"
FinalDf = left_join(df_with_coding , claims_with_code , by = "ID_Policy")
save(FinalDf , file = "FinalDf.RData")
Profit_data = FinalDf
gc()
library(dplyr)
library(readxl)
library(ggplot2)
library(DBI)
library(tidyverse)
library(data.table)
load("FinalDf.RData")
Profit_data = FinalDf
for(i in 42:44){
Profit_data[,i] = ifelse(is.na(Profit_data[,i]) , 0  , Profit_data[,i])
}
Viwq(Profit_data)
Viwe(Profit_data)
View(Profit_data)
c(7:13) - c(14:18)
sum(Profit_data[1,7:13])
sum(Profit_data[1,7:12])
sum(Profit_data[1,7:12]) - sum(Profit_data[1,14:18])
2576314
sum(Profit_data[1,14:18])
sum(Profit_data[1,7:11]) - sum(Profit_data[1,14:18])
sum(Profit_data[1,7:12]) - sum(Profit_data[1,14:18])
sum(Profit_data[1,7:12]) - sum(Profit_data[1,14:18])
sum(Profit_data[1,7:13]) - sum(Profit_data[1,14:18])
View(Profit_data)
Profit_data[,20] + Profit_data[,14] + Profit_data[,15] +
Profit_data[,17] + Profit_data[,18] - Profit_data[,16]
Profit_data[,20]+ Profit_data[,15] +
Profit_data[,17] + Profit_data[,18] - Profit_data[,16]
View(Profit_data)
names(Profit_data)[c(15,18,17,16)]
Profit_data$GrossPremium =  Profit_data$Net_Pr+ Profit_data$Goverment_Complications +
Profit_data$ValueAdded_Tax + Profit_data$ValueAdded_Complications - Profit_data$CentralInsurance_Pension_Pr
Profit_data$TotalLoss = Profit_data$LifeLoss_Value +
Profit_data$PassengerLoss_Value +
Profit_data$FinanceLoss_Value
Profit_data %>% GrossPremium - Profit_data$TotalLoss
Profit_data$Prifit = Profit_data$GrossPremium - Profit_data$TotalLoss
View(Profit_data)
#remove other value columns
Profit_data = Profit_data[,-c(7:20)]
View(Profit_data)
save(Profit_data , file = "Profit_data.RData")
sum(Profit_data$Prifit)
library(dplyr)
library(readxl)
library(ggplot2)
library(DBI)
library(tidyverse)
library(data.table)
load("FinalDf.RData")
Profit_data = FinalDf
for(i in 42:44){
Profit_data[,i] = ifelse(is.na(Profit_data[,i]) , 0  , Profit_data[,i])
}
Profit_data$GrossPremium =  Profit_data$Net_Pr+ Profit_data$Goverment_Complications +
Profit_data$ValueAdded_Tax + Profit_data$ValueAdded_Complications - Profit_data$CentralInsurance_Pension_Pr
Profit_data$TotalLoss = Profit_data$LifeLoss_Value +
Profit_data$PassengerLoss_Value +
Profit_data$FinanceLoss_Value
Profit_data$Profit = Profit_data$GrossPremium - Profit_data$TotalLoss
#remove other value columns
Profit_data = Profit_data[,-c(7:20)]
save(Profit_data , file = "Profit_data.RData")
sum(Profit_data$Profit)
